<?php

namespace App\Http\Livewire;

use App\Models\Barang;
use App\Models\Neraca;
use App\Models\Pengeluaran;
use App\Models\Periode;
use Illuminate\Support\Facades\DB;
use Livewire\Component;

class ReportKeluar extends Component
{
    public $months = [];
    public $period=0;
    public $month=0;
    public $year;
    public $kredit = 0;
    public $isReport;

    public function render()
    {
        $periode = Periode::select('id', DB::raw("CONCAT(if(period=1,concat(year-1,'/',year),concat(year,'/',year+1)),'-',if(period=1,'Semester 2','Semester 1')) AS semester"))->orderBy('id','desc')->pluck('semester','id');
        $pengeluaran = DB::table('pengeluarans')->select('tgl',DB::raw('COUNT(id) as span'))->groupBy('tgl')->get();

        if($this->month){
            $tgl = DB::table('pengeluarans')->whereYear('tgl',$this->year)->whereMonth('tgl',$this->month)->orderByDesc('tgl')->get();

        }else{
            $tgl = [];
        }

        $kredit1 = DB::table('pengeluarans')->join('barangs','barangs.id','pengeluarans.barang_id')->where('barangs.jenis',2)->whereYear('tgl',$this->year)->whereMonth('tgl',$this->month)->select(DB::raw('SUM(harga) as kredit'))->get();
        $kredit2 = DB::table('pengeluarans')->join('barangs','barangs.id','pengeluarans.barang_id')->where('barangs.jenis','!=',2)->whereYear('tgl',$this->year)->whereMonth('tgl',$this->month)->select('barang_id',DB::raw('SUM(harga) as kredit'))->groupBy('barang_id')->get();

        $kre = Pengeluaran::whereYear('tgl',$this->year)->whereMonth('tgl',$this->month)->select(DB::raw('SUM(harga) as kredit'))->get();
        foreach($kre as $k){
            $this->kredit = $k->kredit;
        }
        $barang = Barang::pluck('name','id');
        $satuan = Barang::pluck('satuan','id');
        $peng =  Pengeluaran::pluck('barang_id','id');
        $jenis = Barang::pluck('jenis','id');
        $barangs = Barang::where('jenis','!=',2)->orderBy('id')->get();
        // dd($barangs);
        return view('livewire.report.report-keluar',[
            'periode' => $periode,
            'tgl' => $tgl,
            'kredit' => $this->kredit,
            'kredit1' => $kredit1,
            'kredit2' => $kredit2,
            'barang' => $barang,
            'barangs' => $barangs,
            'satuan' => $satuan,
            'peng' => $peng,
            'jenis' => $jenis,
            'pengeluaran' => $pengeluaran,
            'months' => $this->months
        ]);
    }

    public function month(){
        $periode = Periode::find($this->period);
        $this->year = $periode->year;
        if($periode->period==1){
            $this->months = config('central.month1');
        }elseif($periode->period==2){
            $this->months = config('central.month2');
        }
    }

    public function showReport(){
        $this->isReport = true;
    }

    public function hideReport(){
        $this->isReport = false;
    }

    public function reportNeraca(){
        $cek = Neraca::where('periode_id',$this->period)->where('month',$this->month)->first();
        if($cek){
            $cek->update([
                'pengeluaran' => $this->kredit
            ]);
            session()->flash('info','Uang pengeluaran telah dimasukkan ke Neraca di bulan '.$this->months[$this->month]);
        }else{
            Neraca::create([
                'periode_id' => $this->period,
                'month' => $this->month,
                'pengeluaran' => $this->kredit
            ]);
            session()->flash('info','Uang pengeluaran telah dimasukkan ke Neraca di bulan '.$this->months[$this->month]);
        }
        $this->hideReport();

    }
}
